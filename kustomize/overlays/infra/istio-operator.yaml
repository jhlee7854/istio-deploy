apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
spec:
  profile: minimal
  tag: "1.27.0"
  meshConfig:
    accessLogFile: /dev/stdout
    accessLogEncoding: JSON
    accessLogFormat: |
      {
        "accessLogFormat": "{\"traceID\": \"%REQ(x-b3-traceid)%\",\"protocol\": \"%PROTOCOL%\",\"upstream_service_time\": \"%REQ(x-envoy-upstream-service-time)%\",\"upstream_local_address\": \"%UPSTREAM_LOCAL_ADDRESS%\",\"duration\": \"%DURATION%\",\"upstream_transport_failure_reason\": \"%UPSTREAM_TRANSPORT_FAILURE_REASON%\",\"route_name\": \"%ROUTE_NAME%\",\"downstream_local_address\": \"%DOWNSTREAM_LOCAL_ADDRESS%\",\"user_agent\": \"%REQ(USER-AGENT)%\",\"response_code\": \"%RESPONSE_CODE%\",\"response_flags\": \"%RESPONSE_FLAGS%\",\"start_time\": \"%START_TIME%\",\"method\": \"%REQ(:METHOD)%\",\"request_id\": \"%REQ(X-REQUEST-ID)%\",\"upstream_host\": \"%UPSTREAM_HOST%\",\"x_forwarded_for\": \"%REQ(X-FORWARDED-FOR)%\",\"requested_server_name\": \"%REQUESTED_SERVER_NAME%\",\"bytes_received\": \"%BYTES_RECEIVED%\",\"istio_policy_status\": \"-\",\"bytes_sent\": \"%BYTES_SENT%\",\"upstream_cluster\": \"%UPSTREAM_CLUSTER%\",\"downstream_remote_address\": \"%DOWNSTREAM_REMOTE_ADDRESS%\",\"authority\": \"%REQ(:AUTHORITY)%\",\"path\": \"%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%\"}"
      }
    enableTracing: true
    extensionProviders:
    - name: otel-tracing
      opentelemetry:
        port: 4317
        service: opentelemetry-daemonset-collector.observability.svc.cluster.local
        resource_detectors:
          environment: {}
    defaultProviders:
      metrics:
      - prometheus
      tracing:
      - otel-tracing

    # extensionProviders:
    # - name: otel
    #   envoyOtelAls:
    #     service: application-opentelemetry-collector.observability.svc.cluster.local
    #     port: 4317
    #     logFormat:
    #       labels:
    #         pod: "%ENVIRONMENT(POD_NAME)%"
    #         namespace: "%ENVIRONMENT(POD_NAMESPACE)%"
    #         cluster: "%ENVIRONMENT(ISTIO_META_CLUSTER_ID)%"
    #         mesh: "%ENVIRONMENT(ISTIO_META_MESH_ID)%"
    #         workload: "%ENVIRONMENT(ISTIO_META_WORKLOAD_NAME)%"
    #         protocol: "%PROTOCOL%"
    #         method: "%REQ(:METHOD)%"
    #         path: "%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%"
    #         status: "%RESPONSE_CODE%"
    # defaultProviders:
    #   accessLogging:
    #   - envoy
    #   - otel
